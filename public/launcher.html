async function sendBulkEmails() {
  const sendBtn = document.getElementById("sendBtn");
  const statusText = document.getElementById("statusText");

  // UI feedback start
  sendBtn.disabled = true;
  sendBtn.style.background = "red";
  statusText.innerText = "üì® Sending...";
  statusText.style.color = "red";

  try {
    const yourEmail = localStorage.getItem("yourEmail");
    const appPassword = localStorage.getItem("appPassword");

    const senderName = document.getElementById("senderName").value;
    const subject = document.getElementById("subject").value;
    const messageBody = document.getElementById("message").value;
    const emails = document
      .getElementById("emails")
      .value.split("\n")
      .map((e) => e.trim())
      .filter((e) => e);

    if (!yourEmail || !appPassword) {
      alert("‚ùå Not logged in ‚Äî please sign in again!");
      window.location.href = "login.html";
      return;
    }

    if (emails.length === 0) {
      alert("‚ö†Ô∏è No email addresses entered!");
      return;
    }

    // Start sending
    const res = await fetch("/send-bulk", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        senderName,
        yourEmail,
        appPassword,
        subject,
        messageBody,
        emails,
      }),
    });

    // Parse server response safely
    let data;
    try {
      data = await res.json();
    } catch (err) {
      console.error("Invalid JSON from server:", err);
      alert("‚ùå Server returned invalid response.");
      return;
    }

    if (res.ok && data.ok) {
      statusText.innerText = "‚úÖ Sent successfully!";
      statusText.style.color = "green";
      alert(`‚úÖ ${data.count} emails sent successfully!`);
    } else {
      throw new Error(data.error || "Unknown server error");
    }
  } catch (error) {
    console.error("Error sending emails:", error);
    alert(`‚ùå Failed to send: ${error.message}`);
    statusText.innerText = "‚ùå Failed!";
    statusText.style.color = "red";
  } finally {
    // Reset button state
    sendBtn.disabled = false;
    sendBtn.style.background = "#007bff";
  }
}
